# one cell

A11=[ 0.333333  -0.166667   0.0        0.0       -1.0;
-0.166667   0.333333   0.0        0.0       -1.0;
 0.0        0.0        0.333333  -0.166667  -1.0;
 0.0        0.0       -0.166667   0.333333  -1.0;
 1.0        1.0        1.0        1.0        0.0 ]

 A12=[ 1.0  0.0  0.0  0.0;
 0.0  1.0  0.0  0.0;
 0.0  0.0  1.0  0.0;
 0.0  0.0  0.0  1.0;
 0.0  0.0  0.0  0.0]

 A21=[ 1.0  0.0  0.0  0.0  0.0;
 0.0  1.0  0.0  0.0  0.0;
 0.0  0.0  1.0  0.0  0.0;
 0.0  0.0  0.0  1.0  0.0 ]

S22=-A21*inv(A11)*A12

b1=[
 -0.6666666666666665;
  0.8333333333333331;
 -0.6666666666666665;
  0.8333333333333331;
  1.9999999999999991 ]

y2=-A21*inv(A11)*b1

# Correct result
x1=inv(A11)*(b1-A12*[-3.14;-3.14;-3.14;-3.14])

S_one_cell=[-2.5  -0.5   1.5   1.5;
   -0.5  -2.5   1.5   1.5;
    1.5   1.5  -2.5  -0.5;
    1.5   1.5  -0.5  -2.5 ]

b_one_cell=[0.9999999999999991, -1.9999999999999998, 1.0000000000000002, -1.9999999999999991]


# two cells

# First cell
A11_1=[0.333333  -0.166667   0.0        0.0       -1.0;
    -0.166667   0.333333   0.0        0.0       -1.0;
     0.0        0.0        0.333333  -0.166667  -1.0;
     0.0        0.0       -0.166667   0.333333  -1.0;
     1.0        1.0        1.0        1.0        0.0 ]

A12_1=[1.0  0.0  0.0  0.0;
  0.0  1.0  0.0  0.0;
  0.0  0.0  1.0  0.0;
  0.0  0.0  0.0  1.0;
  0.0  0.0  0.0  0.0]

A21_1=[ 1.0  0.0  0.0  0.0  0.0;
      0.0  1.0  0.0  0.0  0.0;
      0.0  0.0  1.0  0.0  0.0;
      0.0  0.0  0.0  1.0  0.0]

S22_1=-A21_1*inv(A11_1)*A12_1

b1_1=[-0.6666666666666665;
   0.8333333333333331;
  -0.6666666666666665;
   0.8333333333333331;
   1.9999999999999991]

# Second cell
A11_2=A11_1
A12_2=A12_1
A21_2=A21_1

b1_2=[
  -1.1666666666666663;
   1.333333333333333;
  -0.6666666666666665;
   0.8333333333333331;
   1.9999999999999991 ]

S22_2=-A21_2*inv(A11_2)*A12_2

S_two_cells=[-2.5  -0.5   1.5   1.5    0.0    0.0   0.0;
             -0.5  -5.0   1.5   1.5  -0.5   1.5   1.5;
              1.5   1.5  -2.5  -0.5   0.0    0.0     0.0;
              1.5   1.5  -0.5  -2.5    0.0     0.0     0.0;
              0.0   -0.5  0.0   0.0   -2.5   1.5   1.5;
              0.0   1.5   0.0   0.0    1.5  -2.5  -0.5;
             0.0    1.5   0.0   0.0    1.5  -0.5  -2.5 ]

b_two_cells=[
 0.9999999999999991
-6.661338147750939e-16
 1.0000000000000002
-1.9999999999999991
-2.9999999999999996
 1.0000000000000002
-1.9999999999999991
];

dofs_u_cell_1  = [1,2,3,4]
dofs_p_cell_1  = [9]
dofs_up_cell_1 = vcat(dofs_u_cell_1,dofs_p_cell_1)
dofs_l_cell_1 = [11,12,13,14]

dofs_u_cell_2 = [5,6,7,8]
dofs_p_cell_2 = [10]
dofs_up_cell_2 = vcat(dofs_u_cell_2,dofs_p_cell_2)
dofs_l_cell_2 = [12,15,16,17]

A=zeros(17,17)
A[dofs_up_cell_1,dofs_up_cell_1]  = A11_1
A[dofs_up_cell_2,dofs_up_cell_2] += A11_2
A[dofs_up_cell_1,dofs_l_cell_1]  += A12_1
A[dofs_up_cell_2,dofs_l_cell_2]  += A12_2
A[dofs_l_cell_1,dofs_up_cell_1]  += A21_1
A[dofs_l_cell_2,dofs_up_cell_2]  += A21_2

A11g=A[1:10,1:10]
A12g=A[1:10,11:17]
A21g=A[11:17,1:10]
S22g=-A21g*inv(A11g)*A12g

bg=zeros(17)
bg[dofs_up_cell_1]=b1_1
bg[dofs_up_cell_2]=b1_2

y2=-A21g*inv(A11g)*bg[1:10]
x2=y2[2]-dot([-3.14;-3.14;-3.14;-3.14;-3.14;-3.14],vcat(S22g[2,1],S22g[2,3:end]))/S22g[2,2]
x1=inv(A11g)*(bg[1:10]-A12g*[-3.14;x2;-3.14;-3.14;-3.14;-3.14;-3.14])
